### 1. local test 결과
[ConcurrencyTest](src/test/java/com/plusproject/load/ConcurrencyTest.java)에서 실행

#### 설정
    
- 수량 - 10000개
- 쓰레드 - 10개
- 테스트 횟수 - 1000번
- 결과
```
성공 카운트 : 1273
예외 카운트 : 8727
실제 발급된 전체 쿠폰 개수 : 1273
쿠폰 테이블에서 예상한 발급된 쿠폰 개수 : 1001
```
결과를 보면 총 성공 개수와 실제 발급된 쿠폰 개수는 1273개로 동일하다.
하지만 실제 쿠폰 테이블에서 발급된 수량은 1001개로 약 250개의 차이를 보인다.
또한, 쿠폰 테이블의 수량을 업데이트하기위한 요청이 동시에 들어오면서, 데드락이 발생하는 문제도 발견되었다.
본인의 예상으로는 예외 카운트 중 대부분이 데드락으로 인한 에러일 가능성이 많다고 생각한다.

### 2. k6 테스트 결과
테스트코드를 직접 구현해보는것과 더불어,
k6 부하테스트 툴을 사용하여 실제 Application이 동작하였을때의 테스트도 진행해 보았다.
[load_test](load_test.js)를 참고하면 된다.

```
  █ TOTAL RESULTS

    checks_total.......................: 6099   256.837294/s
    checks_succeeded...................: 48.61% 2965 out of 6099
    checks_failed......................: 51.38% 3134 out of 6099

    ✓ login success
    ✗ status is 200
      ↳  48% — ✓ 2964 / ✗ 3134

    HTTP
    http_req_duration.......................................................: avg=14.43ms min=0s     med=6ms    max=427.35ms p(90)=12.2ms  p(95)=15.92ms
      { expected_response:true }............................................: avg=9.46ms  min=3.44ms med=4.83ms max=424.88ms p(90)=10.61ms p(95)=13ms
    http_req_failed.........................................................: 51.38% 3134 out of 6099
    http_reqs...............................................................: 6099   256.837294/s

    EXECUTION
    iteration_duration......................................................: avg=1.72s   min=1s     med=1.28s  max=7.02s    p(90)=2.52s   p(95)=5.49s
    iterations..............................................................: 6098   256.795182/s
    vus.....................................................................: 37     min=37           max=500
    vus_max.................................................................: 500    min=500          max=500

    NETWORK
    data_received...........................................................: 1.5 MB 63 kB/s
    data_sent...............................................................: 2.0 MB 83 kB/s

```

총 6099개 중 2964개가 성공하였다고 나와있다.

발급된 쿠폰의 개수를 
```sql
SELECT COUNT(*) FROM user_coupon
```
를 통해 확인해보면, 
![img.png](img/발급된%20쿠폰의%20개수.png)
처럼 2964개가 되어있다.

하지만 쿠폰 테이블에서 해당 쿠폰의 수량을 확인해보면
![img.png](img/k6를%20이용한%20동시성%20테스트.png)
과 같이 7955개로 나와있다. (초기값은 10000개로 설정하였다.)
10000 - 7955 = 2045이므로, 해당 쿠폰은 2045개만 발급되었다고 생각하지만, 실제로는 2964개로, 약 900개가 더 발급 된 것을 확인할 수 있다.
이를 통해 동시성 테스트 시 문제가 발생할 수 있다는 것을 알 수 있다.

